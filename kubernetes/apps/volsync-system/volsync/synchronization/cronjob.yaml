---
# yaml-language-server: $schema=https://raw.githubusercontent.com/yannh/kubernetes-json-schema/refs/heads/master/v1.34.0/cronjob-batch-v1.json
apiVersion: batch/v1
kind: CronJob
metadata:
  name: kopia-sync
spec:
  schedule: "0 3 * * *" # Daily at 2 AM
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      activeDeadlineSeconds: 10800 # 3 hours
      backoffLimit: 5
      template:
        spec:
          restartPolicy: OnFailure
          serviceAccountName: default
          securityContext:
            fsGroup: 1000
            runAsNonRoot: true
            runAsUser: 1000
          containers:
            - name: kopia-sync
              image: ghcr.io/perfectra1n/volsync:v0.16.13
              imagePullPolicy: IfNotPresent
              command:
                - /bin/sh
                - -c
                - |
                  set -e -o pipefail

                  # Set both cache and log directories to writable mounted location
                  echo "Setting cache directory: ${KOPIA_CACHE_DIR}"
                  export KOPIA_CACHE_DIRECTORY="${KOPIA_CACHE_DIR}"
                  export KOPIA_LOG_DIR="${KOPIA_CACHE_DIR}/logs"

                  # Disable update checking
                  export KOPIA_CHECK_FOR_UPDATES=false

                  echo "Connecting to Kopia repository: ${KOPIA_REPOSITORY}"
                  kopia repository connect filesystem \
                    --path /repository \
                    --password "${KOPIA_PASSWORD}"

                  echo "Starting Kopia synchronization to S3 bucket: ${S3_BUCKET}"
                  kopia repository sync-to s3 \
                    --bucket "${S3_BUCKET}" \
                    --endpoint "${S3_ENDPOINT}" \
                    --delete \
                    --no-progress

                  kopia repository disconnect

                  echo "Synchronization completed successfully"
              env:
                - name: KOPIA_CHECK_FOR_UPDATES
                  value: "false"
                - name: KOPIA_CACHE_DIR
                  value: /cache
                - name: HOME
                  value: /tmp
              envFrom:
                - secretRef:
                    name: kopia-sync-s3-secret
              securityContext:
                allowPrivilegeEscalation: false
                capabilities:
                  drop:
                    - ALL
                privileged: false
                readOnlyRootFilesystem: true
                runAsNonRoot: true
              volumeMounts:
                - name: repository
                  mountPath: /repository
                - name: tmp
                  mountPath: /tmp
                - name: kopia-cache
                  mountPath: /cache
          volumes:
            - name: repository
              nfs:
                server: black-station.internal
                path: /volume1/VolsyncKopia
            - name: tmp
              emptyDir: {}
            - name: kopia-cache
              emptyDir:
                sizeLimit: 8Gi
